(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,51021,e=>{"use strict";var t=e.i(1972),s=e.i(75305);function r({open:e,currentStatus:r,targetStatus:a,onClose:n,onConfirm:l,loading:i=!1}){let[d,o]=(0,s.useState)("");(0,s.useEffect)(()=>{e&&o("")},[e,r,a]);let c=(0,s.useMemo)(()=>"Cannot be Processed"===a||"Processing"===r&&"Issued"===a,[r,a]);return e?(0,t.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4",children:(0,t.jsxs)("div",{className:"w-full max-w-md rounded-lg bg-white p-6 shadow-xl animate-in fade-in slide-in-from-bottom",children:[(0,t.jsx)("h2",{className:"mb-4 text-lg font-semibold",style:{color:"#002449"},children:"Confirm Status Update"}),(0,t.jsxs)("div",{className:"mb-4 space-y-2 text-sm",children:[(0,t.jsxs)("p",{className:"text-gray-600",children:["You are changing the request from ",(0,t.jsx)("span",{className:"font-semibold",children:r})," to "," ",(0,t.jsx)("span",{className:"font-semibold",children:a}),"."]}),(0,t.jsx)("p",{className:"text-[11px] uppercase tracking-wide text-gray-500",children:c?"A remark for the team is required before you continue.":"Review the update and confirm when ready."})]}),c&&(0,t.jsxs)("div",{className:"mb-5 space-y-2",children:[(0,t.jsx)("label",{className:"text-xs font-semibold uppercase tracking-wide text-gray-600",children:"Remarks for Team (required)"}),(0,t.jsx)("textarea",{value:d,onChange:e=>o(e.target.value),placeholder:"Share any guidance or context for the team.",className:"w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[#f75700]/40",rows:3}),(0,t.jsx)("p",{className:"text-[11px] text-gray-500",children:"These remarks are visible to the team on their dashboard and request view."})]}),(0,t.jsxs)("div",{className:"flex gap-3",children:[(0,t.jsx)("button",{type:"button",onClick:n,disabled:i,className:"flex-1 rounded-lg border border-gray-300 px-4 py-2 text-sm font-medium text-gray-700 transition hover:bg-gray-50 disabled:cursor-not-allowed",children:"Cancel"}),(0,t.jsx)("button",{type:"button",onClick:()=>l(d.trim()||void 0),disabled:i,className:"flex-1 rounded-lg bg-[#f75700] px-4 py-2 text-sm font-semibold text-white transition hover:bg-[#f75700]/90 disabled:cursor-not-allowed disabled:opacity-60",children:i?"Updating...":"Confirm"})]})]})}):null}e.s(["StatusChangeModal",()=>r])},49872,e=>{"use strict";var t=e.i(1972),s=e.i(75305),r=e.i(30499),a=e.i(14077),n=e.i(88771),l=e.i(47163),i=e.i(47750),d=e.i(6194),o=e.i(88886),c=e.i(51021);function u(){let e=(0,r.useRouter)(),[l,o]=(0,s.useState)(""),u=a.authService.getCurrentUser(),[b,h]=(0,s.useState)(""),[f,y]=(0,s.useState)(""),[j,v]=(0,s.useState)(""),[w,N]=(0,s.useState)("");(0,s.useEffect)(()=>{if(!a.authService.getAccessToken())return void e.push("/login");let t=a.authService.getCurrentUser();t&&(t.is_poc||t.is_admin)||e.push("/dashboard")},[e]);let{requests:C,live:S,loading:k,error:I,refresh:q,forceReconnect:_,recentlyChangedIds:R}=function(e={}){let{category:t,status:r,fab_type:l,pageSize:d=50,activeOnly:o=!1,resyncIntervalMs:c=3e5,token:u,dropUnfilteredEvents:x=!0}=e,[m,g]=(0,s.useState)([]),[p,b]=(0,s.useState)(!0),[h,f]=(0,s.useState)(""),[y,j]=(0,s.useState)(!1),[v,w]=(0,s.useState)([]),N=(0,s.useRef)(new Map),C=(0,s.useRef)({byId:new Map,list:[]}),S=(0,s.useRef)(null),k=(0,s.useRef)(1e3),I=(0,s.useRef)(!1),q=(0,s.useRef)(null),_=(0,s.useRef)(!1),R=(0,s.useCallback)(e=>{C.current.byId.clear(),e.forEach(e=>C.current.byId.set(e.id,e)),C.current.list=e,g(e)},[]),P=(0,s.useCallback)(e=>[...e].sort((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime()).map((e,t)=>({...e,position:e.position??t+1})),[]),T=(0,s.useCallback)(async()=>{try{b(!0),f("");let e=await n.requestsService.getFilteredQueueSnapshot({include_positions:!0,page:1,page_size:d,category:t,status:r,fab_type:l}),s=o?e.results.filter(e=>!["Issued","Cannot be Processed"].includes(e.status)):e.results;R(P(s))}catch(e){console.error("[queue-hook] snapshot error",e),f(e instanceof Error?e.message:"Snapshot fetch failed")}finally{b(!1)}},[R,P,t,r,l,d,o]),A=(0,s.useCallback)(e=>{let t=C.current;t.byId.set(e.id,e);let s=t.list.findIndex(t=>t.id===e.id);if(s>=0)t.list[s]=e;else{let s=t.list.findIndex(t=>new Date(t.created_at)>new Date(e.created_at));-1===s?t.list.push(e):t.list.splice(s,0,e)}let r=t.list;o&&(r=r.filter(e=>!["Issued","Cannot be Processed"].includes(e.status))),g(P(r))},[o,P]),D=(0,s.useCallback)((e,t)=>{let s=C.current,r=s.byId.get(e);if(!r)return;let a={...r,status:t};s.byId.set(e,a);let n=s.list.findIndex(t=>t.id===e);n>=0&&(s.list[n]=a);let l=s.list;o&&["Issued","Cannot be Processed"].includes(a.status)&&(s.list=l=l.filter(t=>t.id!==e)),g(P(l))},[o,P]),O=(0,s.useCallback)(e=>{w(t=>t.includes(e)?t:[...t,e]);let t=N.current.get(e);t&&clearTimeout(t);let s=setTimeout(()=>{w(t=>t.filter(t=>t!==e)),N.current.delete(e)},2e3);N.current.set(e,s)},[]),M=(0,s.useCallback)(e=>{if("request_created"===e.event||"request_updated"===e.event){if(e.request){if(x&&(t&&e.request.category!==t||r&&e.request.status!==r||l&&e.request.fabrication?.fab_type!==l))return;A(e.request),O(e.request.id)}}else"state_transition"===e.event&&e.request_id&&(D(e.request_id,e.to||""),O(e.request_id))},[A,D,t,r,l,x,O]),E=(0,s.useCallback)(()=>{let e=u||a.authService.getAccessToken();if(!e)return;let t=(0,i.buildRequestsWsUrl)(e);if(t)try{S.current=new WebSocket(t),S.current.onopen=()=>{j(!0),k.current=1e3,I.current&&(T(),I.current=!1)},S.current.onmessage=e=>{try{let t=JSON.parse(e.data);M(t)}catch(e){console.error("[queue-hook] parse error",e)}},S.current.onclose=()=>{if(j(!1),_.current)return;I.current=!0;let e=k.current;setTimeout(()=>{k.current=Math.min(1.5*k.current,3e4),E()},e)},S.current.onerror=e=>{console.error("[queue-hook] ws error",e)}}catch(e){console.error("[queue-hook] ws connect error",e)}},[M,T]),L=(0,s.useCallback)(async()=>{await T()},[T]),U=(0,s.useCallback)(()=>{S.current?S.current.close():E()},[E]);return(0,s.useEffect)(()=>(_.current=!1,T().then(()=>E()),q.current=setInterval(()=>{_.current||T()},c),()=>{_.current=!0,q.current&&clearInterval(q.current),S.current?.close()}),[t,r,l,d,o]),{requests:m,live:y,loading:p,error:h,refresh:L,upsertById:A,forceReconnect:U,recentlyChangedIds:v}}({token:a.authService.getAccessToken(),pageSize:50,activeOnly:!1,resyncIntervalMs:3e5});(0,s.useEffect)(()=>{I&&o(I)},[I]);let[P,T]=(0,s.useState)([]),[A,D]=(0,s.useState)(null),O=(0,s.useCallback)((e,t)=>"Cannot be Processed"===t||"Processing"===e&&"Issued"===t,[]),M=async(e,t,s)=>{T(t=>t.includes(e)?t:[...t,e]);let r=`Status changed to ${t}`;try{await n.requestsService.changeRequestStatus(e,t,r,s),o(""),D(null)}catch(e){o(e instanceof Error?e.message:"Failed to change status")}finally{T(t=>t.filter(t=>t!==e))}},E=(e,t)=>{O(e.status,t)?D({request:e,nextStatus:t}):M(e.id,t)},L=(0,s.useMemo)(()=>{let e=C.filter(e=>(!b||e.category===b)&&(!f||e.status===f)&&(!j||e.fabrication?.fab_type===j)&&(!w||!!((e.notes||"")+" "+e.bom_items.map(e=>e.item_name).join(" ")+" "+e.additional_items.map(e=>e.item_name).join(" ")).toLowerCase().includes(w.toLowerCase()))&&!0);return f?e:e.filter(e=>"Issued"!==e.status&&"Cannot be Processed"!==e.status)},[C,b,f,j,w]),U=(0,s.useMemo)(()=>({total:L.length,submitted:L.filter(e=>"Submitted"===e.status).length,processing:L.filter(e=>"Processing"===e.status).length,issued:L.filter(e=>"Issued"===e.status).length,rejected:L.filter(e=>"Cannot be Processed"===e.status).length}),[L]);return(0,t.jsxs)(d.DashboardShell,{children:[(0,t.jsxs)("div",{className:"space-y-8",children:[(0,t.jsx)("div",{className:"w-full bg-white border border-gray-200 rounded-lg overflow-hidden",children:(0,t.jsxs)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5",children:[(0,t.jsx)(m,{label:"Total",value:U.total,color:"#002449"}),(0,t.jsx)(m,{label:"Submitted",value:U.submitted,color:"#f75700"}),(0,t.jsx)(m,{label:"Processing",value:U.processing,color:"#007367"}),(0,t.jsx)(m,{label:"Issued",value:U.issued,color:"#078e31"}),(0,t.jsx)(m,{label:"Rejected",value:U.rejected,color:"#6b7280"})]})}),(0,t.jsx)(p,{live:S,onRefresh:q,onReconnect:_,ordering:"FCFS"}),(0,t.jsx)("div",{className:"bg-white border border-gray-200 rounded-lg p-3 flex flex-col gap-3",children:(0,t.jsxs)("div",{className:"flex flex-wrap gap-3 items-center",children:[(0,t.jsx)(g,{label:"Category",value:b,onChange:h,options:["","BOM","ADDITIONAL","FABRICATION"]}),(0,t.jsx)(g,{label:"Status",value:f,onChange:y,options:["","Submitted","Processing","Issued","Cannot be Processed"]}),(0,t.jsx)(g,{label:"Fab",value:j,onChange:v,options:["","3D","LASER","OTHER"]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 ml-auto w-full sm:w-auto",children:[(0,t.jsx)("input",{type:"text",placeholder:"Search",value:w,onChange:e=>N(e.target.value),className:"px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent w-full sm:w-56"}),(0,t.jsx)("button",{onClick:()=>{h(""),y(""),v(""),N("")},className:"px-3 py-2 text-sm rounded-md border border-gray-300 hover:bg-gray-50",children:"Clear"})]})]})}),l&&(0,t.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6",children:(0,t.jsx)("p",{className:"text-red-800",children:l})}),(0,t.jsx)("div",{className:"space-y-3",children:k?(0,t.jsx)("div",{className:"py-12 text-center text-sm text-gray-600 bg-white border border-gray-200 rounded-lg",children:"Loading queue..."}):0===L.length?(0,t.jsx)("div",{className:"py-12 text-center text-sm text-gray-600 bg-white border border-gray-200 rounded-lg",children:"No requests match filters."}):(0,t.jsx)("ul",{className:"space-y-3",children:L.map((e,s)=>(0,t.jsx)("li",{children:(0,t.jsx)(x,{request:e,position:s+1,onAdvance:E,canAdvance:!!u&&(u.is_poc||u.is_admin),highlight:R.includes(e.id),loading:P.includes(e.id)})},e.id))})})]}),A&&(0,t.jsx)(c.StatusChangeModal,{open:!!A,currentStatus:A.request.status,targetStatus:A.nextStatus,loading:P.includes(A.request.id),onClose:()=>D(null),onConfirm:async e=>{A&&await M(A.request.id,A.nextStatus,e)}})]})}function x({request:e,position:s,onAdvance:r,canAdvance:a,highlight:n=!1,loading:i=!1}){var d,c;let u="Submitted"===e.status?"Processing":"Processing"===e.status?"Issued":"";return(0,t.jsxs)("div",{className:`relative bg-white border border-gray-200 rounded-lg p-4 flex flex-col gap-3 shadow-sm hover:shadow-md transition ${n?"flash-update":""} ${i?"opacity-60 pointer-events-none":""}`,children:[(0,t.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,t.jsx)("span",{className:"inline-flex items-center justify-center w-6 h-6 text-[11px] font-semibold rounded-full bg-gray-100 border border-gray-200 text-gray-600",children:s}),(0,t.jsx)("span",{className:"px-2 py-1 text-[11px] font-semibold text-white rounded-md",style:{backgroundColor:"BOM"===(d=e.category)?"#002449":"ADDITIONAL"===d?"#007367":"FABRICATION"===d?"#f75700":"#6b7280"},children:e.category}),(0,t.jsx)(o.RequestProgress,{status:e.status}),(0,t.jsx)("span",{className:"px-2 py-1 text-[11px] font-semibold rounded-md",style:{backgroundColor:"Submitted"===(c=e.status)?"#f75700":"Processing"===c?"#007367":"Issued"===c?"#078e31":"Cannot be Processed"===c?"#6b7280":"#002449",color:"#fff"},children:e.status}),e.team_name&&(0,t.jsx)("span",{className:"ml-auto inline-flex items-center gap-1 px-3 py-1 text-[11px] font-semibold rounded-full bg-[#002449] text-white",children:e.team_name})]}),(0,t.jsx)("h3",{className:"text-sm font-semibold text-gray-900 line-clamp-2",children:(0,l.formatRequestTitle)(e)}),(0,t.jsxs)("div",{className:"flex flex-wrap gap-4 text-[11px] text-gray-600",children:[(e.bom_items?.length||0)>0&&(0,t.jsxs)("span",{children:["BOM: ",e.bom_items.length]}),(e.additional_items?.length||0)>0&&(0,t.jsxs)("span",{children:["Additional: ",e.additional_items.length]}),e.fabrication&&(0,t.jsxs)("span",{children:["Fab: ",e.fabrication.fab_type," â€¢ ",e.fabrication.name]}),(0,t.jsxs)("span",{children:["Created: ",new Date(e.created_at).toLocaleTimeString()]}),(0,t.jsxs)("span",{children:["Updated: ",new Date(e.updated_at).toLocaleTimeString()]})]}),(0,t.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,t.jsx)("a",{href:`/requests/${e.id}`,className:"px-3 py-1.5 text-[11px] font-medium rounded-md border border-gray-300 hover:bg-gray-50",children:"View"}),a&&u&&(0,t.jsx)("button",{onClick:()=>r(e,u),disabled:i,className:"px-3 py-1.5 text-[11px] font-medium rounded-md text-white",style:{backgroundColor:"Processing"===u?"#007367":"#078e31"},children:"Processing"===u?"Accept":"Issue"}),a&&"Issued"!==e.status&&"Cannot be Processed"!==e.status&&(0,t.jsx)("button",{onClick:()=>r(e,"Cannot be Processed"),disabled:i,className:"px-3 py-1.5 text-[11px] font-medium rounded-md text-white bg-[#f75700]",children:"Reject"}),i&&(0,t.jsx)("span",{className:"inline-flex items-center gap-1 px-2 py-1 text-[10px] font-medium rounded bg-gray-800 text-white",children:"Updating..."})]}),e.remarks&&(0,t.jsxs)("div",{className:"rounded-md border border-dashed border-gray-200 bg-gray-50 px-3 py-2 text-[11px] text-gray-600",children:[(0,t.jsx)("p",{className:"mb-1 text-[10px] font-semibold uppercase tracking-wide text-[#002449]",children:"Remarks"}),(0,t.jsx)("p",{className:"whitespace-pre-line text-xs text-gray-700",children:e.remarks})]})]})}function m({label:e,value:s,color:r}){return(0,t.jsxs)("div",{className:"flex items-center justify-between gap-2 px-4 py-2 text-sm border-r last:border-r-0 border-gray-200",children:[(0,t.jsx)("span",{className:"text-[11px] font-medium text-gray-500 uppercase tracking-wide",children:e}),(0,t.jsx)("span",{className:"text-base font-semibold",style:{color:r},children:s})]})}function g({label:e,options:s,value:r,onChange:a}){return(0,t.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,t.jsx)("span",{className:"text-[10px] uppercase tracking-wide font-semibold text-gray-500",children:e}),(0,t.jsx)("div",{className:"flex flex-wrap gap-1",children:s.map(e=>(0,t.jsx)("button",{onClick:()=>a(e),className:(0,l.cn)("px-2 py-1 text-[11px] rounded-md border transition-colors",r===e?"bg-accent text-white border-accent":"bg-white hover:bg-gray-50 text-gray-600 border-gray-300"),type:"button",children:""===e?"All":e},e||"all"))})]})}function p({live:e,ordering:s,onRefresh:r,onReconnect:a}){return(0,t.jsxs)("div",{className:"flex flex-wrap gap-3 items-center bg-white border border-gray-200 rounded-lg p-3",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-md text-[11px] font-medium ${e?"bg-green-50 text-green-700 border border-green-200":"bg-red-50 text-red-700 border border-red-200"}`,children:[(0,t.jsx)("span",{className:`inline-block w-2 h-2 rounded-full ${e?"bg-green-500 animate-pulse":"bg-red-500"}`}),e?"Live":"Disconnected"]}),(0,t.jsxs)("span",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-md text-[11px] font-medium bg-gray-50 border border-gray-200",children:["Ordering: ",s]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 ml-auto",children:[(0,t.jsx)("button",{onClick:r,className:"px-3 py-1.5 text-[11px] font-medium rounded-md border border-gray-300 hover:bg-gray-50",children:"Refresh"}),(0,t.jsx)("button",{onClick:a,className:"px-3 py-1.5 text-[11px] font-medium rounded-md border border-gray-300 hover:bg-gray-50",children:"Reconnect"})]})]})}e.s(["default",()=>u],49872)}]);