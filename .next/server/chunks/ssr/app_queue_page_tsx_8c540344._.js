module.exports=[91248,a=>{"use strict";var b=a.i(46447),c=a.i(30564),d=a.i(1470),e=a.i(11634),f=a.i(84120),g=a.i(97895),h=a.i(4532),i=a.i(90599),j=a.i(93107),k=a.i(72609);function l(){let a=(0,d.useRouter)(),[g,j]=(0,c.useState)(""),l=e.authService.getCurrentUser(),[q,r]=(0,c.useState)(""),[s,t]=(0,c.useState)(""),[u,v]=(0,c.useState)(""),[w,x]=(0,c.useState)("");(0,c.useEffect)(()=>{if(!e.authService.getAccessToken())return void a.push("/login");let b=e.authService.getCurrentUser();b&&(b.is_poc||b.is_admin)||a.push("/dashboard")},[a]);let{requests:y,live:z,loading:A,error:B,refresh:C,forceReconnect:D,recentlyChangedIds:E}=function(a={}){let{category:b,status:d,fab_type:g,pageSize:i=50,activeOnly:j=!1,resyncIntervalMs:k=3e5,token:l,dropUnfilteredEvents:m=!0}=a,[n,o]=(0,c.useState)([]),[p,q]=(0,c.useState)(!0),[r,s]=(0,c.useState)(""),[t,u]=(0,c.useState)(!1),[v,w]=(0,c.useState)([]),x=(0,c.useRef)(new Map),y=(0,c.useRef)({byId:new Map,list:[]}),z=(0,c.useRef)(null),A=(0,c.useRef)(1e3),B=(0,c.useRef)(!1),C=(0,c.useRef)(null),D=(0,c.useRef)(!1),E=(0,c.useCallback)(a=>{y.current.byId.clear(),a.forEach(a=>y.current.byId.set(a.id,a)),y.current.list=a,o(a)},[]),F=(0,c.useCallback)(a=>[...a].sort((a,b)=>new Date(a.created_at).getTime()-new Date(b.created_at).getTime()).map((a,b)=>({...a,position:a.position??b+1})),[]),G=(0,c.useCallback)(async()=>{try{q(!0),s("");let a=await f.requestsService.getFilteredQueueSnapshot({include_positions:!0,page:1,page_size:i,category:b,status:d,fab_type:g}),c=j?a.results.filter(a=>!["Issued","Cannot be Processed"].includes(a.status)):a.results;E(F(c))}catch(a){console.error("[queue-hook] snapshot error",a),s(a instanceof Error?a.message:"Snapshot fetch failed")}finally{q(!1)}},[E,F,b,d,g,i,j]),H=(0,c.useCallback)(a=>{let b=y.current;b.byId.set(a.id,a);let c=b.list.findIndex(b=>b.id===a.id);if(c>=0)b.list[c]=a;else{let c=b.list.findIndex(b=>new Date(b.created_at)>new Date(a.created_at));-1===c?b.list.push(a):b.list.splice(c,0,a)}let d=b.list;j&&(d=d.filter(a=>!["Issued","Cannot be Processed"].includes(a.status))),o(F(d))},[j,F]),I=(0,c.useCallback)((a,b)=>{let c=y.current,d=c.byId.get(a);if(!d)return;let e={...d,status:b};c.byId.set(a,e);let f=c.list.findIndex(b=>b.id===a);f>=0&&(c.list[f]=e);let g=c.list;j&&["Issued","Cannot be Processed"].includes(e.status)&&(c.list=g=g.filter(b=>b.id!==a)),o(F(g))},[j,F]),J=(0,c.useCallback)(a=>{w(b=>b.includes(a)?b:[...b,a]);let b=x.current.get(a);b&&clearTimeout(b);let c=setTimeout(()=>{w(b=>b.filter(b=>b!==a)),x.current.delete(a)},2e3);x.current.set(a,c)},[]),K=(0,c.useCallback)(a=>{if("request_created"===a.event||"request_updated"===a.event){if(a.request){if(m&&(b&&a.request.category!==b||d&&a.request.status!==d||g&&a.request.fabrication?.fab_type!==g))return;H(a.request),J(a.request.id)}}else"state_transition"===a.event&&a.request_id&&(I(a.request_id,a.to||""),J(a.request_id))},[H,I,b,d,g,m,J]),L=(0,c.useCallback)(()=>{let a=l||e.authService.getAccessToken();if(!a)return;let b=(0,h.buildRequestsWsUrl)(a);if(b)try{z.current=new WebSocket(b),z.current.onopen=()=>{u(!0),A.current=1e3,B.current&&(G(),B.current=!1)},z.current.onmessage=a=>{try{let b=JSON.parse(a.data);K(b)}catch(a){console.error("[queue-hook] parse error",a)}},z.current.onclose=()=>{if(u(!1),D.current)return;B.current=!0;let a=A.current;setTimeout(()=>{A.current=Math.min(1.5*A.current,3e4),L()},a)},z.current.onerror=a=>{console.error("[queue-hook] ws error",a)}}catch(a){console.error("[queue-hook] ws connect error",a)}},[K,G]),M=(0,c.useCallback)(async()=>{await G()},[G]),N=(0,c.useCallback)(()=>{z.current?z.current.close():L()},[L]);return(0,c.useEffect)(()=>(D.current=!1,G().then(()=>L()),C.current=setInterval(()=>{D.current||G()},k),()=>{D.current=!0,C.current&&clearInterval(C.current),z.current?.close()}),[b,d,g,i,j]),{requests:n,live:t,loading:p,error:r,refresh:M,upsertById:H,forceReconnect:N,recentlyChangedIds:v}}({token:e.authService.getAccessToken(),pageSize:50,activeOnly:!1,resyncIntervalMs:3e5});(0,c.useEffect)(()=>{B&&j(B)},[B]);let[F,G]=(0,c.useState)([]),[H,I]=(0,c.useState)(null),J=(0,c.useCallback)((a,b)=>"Cannot be Processed"===b||"Processing"===a&&"Issued"===b,[]),K=async(a,b,c)=>{G(b=>b.includes(a)?b:[...b,a]);let d=`Status changed to ${b}`;try{await f.requestsService.changeRequestStatus(a,b,d,c),j(""),I(null)}catch(a){j(a instanceof Error?a.message:"Failed to change status")}finally{G(b=>b.filter(b=>b!==a))}},L=(a,b)=>{J(a.status,b)?I({request:a,nextStatus:b}):K(a.id,b)},M=(0,c.useMemo)(()=>{let a=y.filter(a=>(!q||a.category===q)&&(!s||a.status===s)&&(!u||a.fabrication?.fab_type===u)&&(!w||!!((a.notes||"")+" "+a.bom_items.map(a=>a.item_name).join(" ")+" "+a.additional_items.map(a=>a.item_name).join(" ")).toLowerCase().includes(w.toLowerCase()))&&!0);return s?a:a.filter(a=>"Issued"!==a.status&&"Cannot be Processed"!==a.status)},[y,q,s,u,w]),N=(0,c.useMemo)(()=>({total:M.length,submitted:M.filter(a=>"Submitted"===a.status).length,processing:M.filter(a=>"Processing"===a.status).length,issued:M.filter(a=>"Issued"===a.status).length,rejected:M.filter(a=>"Cannot be Processed"===a.status).length}),[M]);return(0,b.jsxs)(i.DashboardShell,{children:[(0,b.jsxs)("div",{className:"space-y-8",children:[(0,b.jsx)("div",{className:"w-full bg-white border border-gray-200 rounded-lg overflow-hidden",children:(0,b.jsxs)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5",children:[(0,b.jsx)(n,{label:"Total",value:N.total,color:"#002449"}),(0,b.jsx)(n,{label:"Submitted",value:N.submitted,color:"#f75700"}),(0,b.jsx)(n,{label:"Processing",value:N.processing,color:"#007367"}),(0,b.jsx)(n,{label:"Issued",value:N.issued,color:"#078e31"}),(0,b.jsx)(n,{label:"Rejected",value:N.rejected,color:"#6b7280"})]})}),(0,b.jsx)(p,{live:z,onRefresh:C,onReconnect:D,ordering:"FCFS"}),(0,b.jsx)("div",{className:"bg-white border border-gray-200 rounded-lg p-3 flex flex-col gap-3",children:(0,b.jsxs)("div",{className:"flex flex-wrap gap-3 items-center",children:[(0,b.jsx)(o,{label:"Category",value:q,onChange:r,options:["","BOM","ADDITIONAL","FABRICATION"]}),(0,b.jsx)(o,{label:"Status",value:s,onChange:t,options:["","Submitted","Processing","Issued","Cannot be Processed"]}),(0,b.jsx)(o,{label:"Fab",value:u,onChange:v,options:["","3D","LASER","OTHER"]}),(0,b.jsxs)("div",{className:"flex items-center gap-2 ml-auto w-full sm:w-auto",children:[(0,b.jsx)("input",{type:"text",placeholder:"Search",value:w,onChange:a=>x(a.target.value),className:"px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent w-full sm:w-56"}),(0,b.jsx)("button",{onClick:()=>{r(""),t(""),v(""),x("")},className:"px-3 py-2 text-sm rounded-md border border-gray-300 hover:bg-gray-50",children:"Clear"})]})]})}),g&&(0,b.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6",children:(0,b.jsx)("p",{className:"text-red-800",children:g})}),(0,b.jsx)("div",{className:"space-y-3",children:A?(0,b.jsx)("div",{className:"py-12 text-center text-sm text-gray-600 bg-white border border-gray-200 rounded-lg",children:"Loading queue..."}):0===M.length?(0,b.jsx)("div",{className:"py-12 text-center text-sm text-gray-600 bg-white border border-gray-200 rounded-lg",children:"No requests match filters."}):(0,b.jsx)("ul",{className:"space-y-3",children:M.map((a,c)=>(0,b.jsx)("li",{children:(0,b.jsx)(m,{request:a,position:c+1,onAdvance:L,canAdvance:!!l&&(l.is_poc||l.is_admin),highlight:E.includes(a.id),loading:F.includes(a.id)})},a.id))})})]}),H&&(0,b.jsx)(k.StatusChangeModal,{open:!!H,currentStatus:H.request.status,targetStatus:H.nextStatus,loading:F.includes(H.request.id),onClose:()=>I(null),onConfirm:async a=>{H&&await K(H.request.id,H.nextStatus,a)}})]})}function m({request:a,position:c,onAdvance:d,canAdvance:e,highlight:f=!1,loading:h=!1}){var i,k;let l="Submitted"===a.status?"Processing":"Processing"===a.status?"Issued":"";return(0,b.jsxs)("div",{className:`relative bg-white border border-gray-200 rounded-lg p-4 flex flex-col gap-3 shadow-sm hover:shadow-md transition ${f?"flash-update":""} ${h?"opacity-60 pointer-events-none":""}`,children:[(0,b.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,b.jsx)("span",{className:"inline-flex items-center justify-center w-6 h-6 text-[11px] font-semibold rounded-full bg-gray-100 border border-gray-200 text-gray-600",children:c}),(0,b.jsx)("span",{className:"px-2 py-1 text-[11px] font-semibold text-white rounded-md",style:{backgroundColor:"BOM"===(i=a.category)?"#002449":"ADDITIONAL"===i?"#007367":"FABRICATION"===i?"#f75700":"#6b7280"},children:a.category}),(0,b.jsx)(j.RequestProgress,{status:a.status}),(0,b.jsx)("span",{className:"px-2 py-1 text-[11px] font-semibold rounded-md",style:{backgroundColor:"Submitted"===(k=a.status)?"#f75700":"Processing"===k?"#007367":"Issued"===k?"#078e31":"Cannot be Processed"===k?"#6b7280":"#002449",color:"#fff"},children:a.status}),a.team_name&&(0,b.jsx)("span",{className:"ml-auto inline-flex items-center gap-1 px-3 py-1 text-[11px] font-semibold rounded-full bg-[#002449] text-white",children:a.team_name})]}),(0,b.jsx)("h3",{className:"text-sm font-semibold text-gray-900 line-clamp-2",children:(0,g.formatRequestTitle)(a)}),(0,b.jsxs)("div",{className:"flex flex-wrap gap-4 text-[11px] text-gray-600",children:[(a.bom_items?.length||0)>0&&(0,b.jsxs)("span",{children:["BOM: ",a.bom_items.length]}),(a.additional_items?.length||0)>0&&(0,b.jsxs)("span",{children:["Additional: ",a.additional_items.length]}),a.fabrication&&(0,b.jsxs)("span",{children:["Fab: ",a.fabrication.fab_type," â€¢ ",a.fabrication.name]}),(0,b.jsxs)("span",{children:["Created: ",new Date(a.created_at).toLocaleTimeString()]}),(0,b.jsxs)("span",{children:["Updated: ",new Date(a.updated_at).toLocaleTimeString()]})]}),(0,b.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,b.jsx)("a",{href:`/requests/${a.id}`,className:"px-3 py-1.5 text-[11px] font-medium rounded-md border border-gray-300 hover:bg-gray-50",children:"View"}),e&&l&&(0,b.jsx)("button",{onClick:()=>d(a,l),disabled:h,className:"px-3 py-1.5 text-[11px] font-medium rounded-md text-white",style:{backgroundColor:"Processing"===l?"#007367":"#078e31"},children:"Processing"===l?"Accept":"Issue"}),e&&"Issued"!==a.status&&"Cannot be Processed"!==a.status&&(0,b.jsx)("button",{onClick:()=>d(a,"Cannot be Processed"),disabled:h,className:"px-3 py-1.5 text-[11px] font-medium rounded-md text-white bg-[#f75700]",children:"Reject"}),h&&(0,b.jsx)("span",{className:"inline-flex items-center gap-1 px-2 py-1 text-[10px] font-medium rounded bg-gray-800 text-white",children:"Updating..."})]}),a.remarks&&(0,b.jsxs)("div",{className:"rounded-md border border-dashed border-gray-200 bg-gray-50 px-3 py-2 text-[11px] text-gray-600",children:[(0,b.jsx)("p",{className:"mb-1 text-[10px] font-semibold uppercase tracking-wide text-[#002449]",children:"Remarks"}),(0,b.jsx)("p",{className:"whitespace-pre-line text-xs text-gray-700",children:a.remarks})]})]})}function n({label:a,value:c,color:d}){return(0,b.jsxs)("div",{className:"flex items-center justify-between gap-2 px-4 py-2 text-sm border-r last:border-r-0 border-gray-200",children:[(0,b.jsx)("span",{className:"text-[11px] font-medium text-gray-500 uppercase tracking-wide",children:a}),(0,b.jsx)("span",{className:"text-base font-semibold",style:{color:d},children:c})]})}function o({label:a,options:c,value:d,onChange:e}){return(0,b.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,b.jsx)("span",{className:"text-[10px] uppercase tracking-wide font-semibold text-gray-500",children:a}),(0,b.jsx)("div",{className:"flex flex-wrap gap-1",children:c.map(a=>(0,b.jsx)("button",{onClick:()=>e(a),className:(0,g.cn)("px-2 py-1 text-[11px] rounded-md border transition-colors",d===a?"bg-accent text-white border-accent":"bg-white hover:bg-gray-50 text-gray-600 border-gray-300"),type:"button",children:""===a?"All":a},a||"all"))})]})}function p({live:a,ordering:c,onRefresh:d,onReconnect:e}){return(0,b.jsxs)("div",{className:"flex flex-wrap gap-3 items-center bg-white border border-gray-200 rounded-lg p-3",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsxs)("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-md text-[11px] font-medium ${a?"bg-green-50 text-green-700 border border-green-200":"bg-red-50 text-red-700 border border-red-200"}`,children:[(0,b.jsx)("span",{className:`inline-block w-2 h-2 rounded-full ${a?"bg-green-500 animate-pulse":"bg-red-500"}`}),a?"Live":"Disconnected"]}),(0,b.jsxs)("span",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-md text-[11px] font-medium bg-gray-50 border border-gray-200",children:["Ordering: ",c]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2 ml-auto",children:[(0,b.jsx)("button",{onClick:d,className:"px-3 py-1.5 text-[11px] font-medium rounded-md border border-gray-300 hover:bg-gray-50",children:"Refresh"}),(0,b.jsx)("button",{onClick:e,className:"px-3 py-1.5 text-[11px] font-medium rounded-md border border-gray-300 hover:bg-gray-50",children:"Reconnect"})]})]})}a.s(["default",()=>l],91248)}];

//# sourceMappingURL=app_queue_page_tsx_8c540344._.js.map