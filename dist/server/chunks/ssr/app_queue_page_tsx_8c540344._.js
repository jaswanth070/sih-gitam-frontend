module.exports=[91248,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(50944),e=a.i(11634),f=a.i(84120),g=a.i(97895),h=a.i(90599),i=a.i(93107);function j(){let a=(0,d.useRouter)(),[g,i]=(0,c.useState)(""),j=e.authService.getCurrentUser(),[o,p]=(0,c.useState)(""),[q,r]=(0,c.useState)(""),[s,t]=(0,c.useState)(""),[u,v]=(0,c.useState)("");(0,c.useEffect)(()=>{if(!e.authService.getAccessToken())return void a.push("/login");let b=e.authService.getCurrentUser();b&&(b.is_poc||b.is_admin)||a.push("/dashboard")},[a]);let{requests:w,live:x,loading:y,error:z,refresh:A,forceReconnect:B,recentlyChangedIds:C}=function(a={}){let{category:b,status:d,fab_type:g,pageSize:h=50,activeOnly:i=!1,resyncIntervalMs:j=3e5,token:k,dropUnfilteredEvents:l=!0}=a,[m,n]=(0,c.useState)([]),[o,p]=(0,c.useState)(!0),[q,r]=(0,c.useState)(""),[s,t]=(0,c.useState)(!1),[u,v]=(0,c.useState)([]),w=(0,c.useRef)(new Map),x=(0,c.useRef)({byId:new Map,list:[]}),y=(0,c.useRef)(null),z=(0,c.useRef)(1e3),A=(0,c.useRef)(!1),B=(0,c.useRef)(null),C=(0,c.useRef)(!1),D=(0,c.useCallback)(a=>{x.current.byId.clear(),a.forEach(a=>x.current.byId.set(a.id,a)),x.current.list=a,n(a)},[]),E=(0,c.useCallback)(a=>[...a].sort((a,b)=>new Date(a.created_at).getTime()-new Date(b.created_at).getTime()).map((a,b)=>({...a,position:a.position??b+1})),[]),F=(0,c.useCallback)(async()=>{try{p(!0),r("");let a=await f.requestsService.getFilteredQueueSnapshot({include_positions:!0,page:1,page_size:h,category:b,status:d,fab_type:g}),c=i?a.results.filter(a=>!["Issued","Cannot be Processed"].includes(a.status)):a.results;D(E(c))}catch(a){console.error("[queue-hook] snapshot error",a),r(a instanceof Error?a.message:"Snapshot fetch failed")}finally{p(!1)}},[D,E,b,d,g,h,i]),G=(0,c.useCallback)(a=>{let b=x.current;b.byId.set(a.id,a);let c=b.list.findIndex(b=>b.id===a.id);if(c>=0)b.list[c]=a;else{let c=b.list.findIndex(b=>new Date(b.created_at)>new Date(a.created_at));-1===c?b.list.push(a):b.list.splice(c,0,a)}let d=b.list;i&&(d=d.filter(a=>!["Issued","Cannot be Processed"].includes(a.status))),n(E(d))},[i,E]),H=(0,c.useCallback)((a,b)=>{let c=x.current,d=c.byId.get(a);if(!d)return;let e={...d,status:b};c.byId.set(a,e);let f=c.list.findIndex(b=>b.id===a);f>=0&&(c.list[f]=e);let g=c.list;i&&["Issued","Cannot be Processed"].includes(e.status)&&(c.list=g=g.filter(b=>b.id!==a)),n(E(g))},[i,E]),I=(0,c.useCallback)(a=>{v(b=>b.includes(a)?b:[...b,a]);let b=w.current.get(a);b&&clearTimeout(b);let c=setTimeout(()=>{v(b=>b.filter(b=>b!==a)),w.current.delete(a)},2e3);w.current.set(a,c)},[]),J=(0,c.useCallback)(a=>{if("request_created"===a.event||"request_updated"===a.event){if(a.request){if(l&&(b&&a.request.category!==b||d&&a.request.status!==d||g&&a.request.fabrication?.fab_type!==g))return;G(a.request),I(a.request.id)}}else"state_transition"===a.event&&a.request_id&&(H(a.request_id,a.to||""),I(a.request_id))},[G,H,b,d,g,l,I]),K=(0,c.useCallback)(()=>{let a=k||e.authService.getAccessToken();if(!a)return;let b="";try{b=new URL("http://127.0.0.1:8001/api").origin}catch{}b||(b="http://127.0.0.1:8001");let c=b.startsWith("https://"),d=b.replace(/^https?:\/\//,""),f=`${c?"wss":"ws"}://${d}/ws/requests/?token=${encodeURIComponent(a)}`;try{y.current=new WebSocket(f),y.current.onopen=()=>{t(!0),z.current=1e3,A.current&&(F(),A.current=!1)},y.current.onmessage=a=>{try{let b=JSON.parse(a.data);J(b)}catch(a){console.error("[queue-hook] parse error",a)}},y.current.onclose=()=>{if(t(!1),C.current)return;A.current=!0;let a=z.current;setTimeout(()=>{z.current=Math.min(1.5*z.current,3e4),K()},a)},y.current.onerror=a=>{console.error("[queue-hook] ws error",a)}}catch(a){console.error("[queue-hook] ws connect error",a)}},[J,F]),L=(0,c.useCallback)(async()=>{await F()},[F]),M=(0,c.useCallback)(()=>{y.current?y.current.close():K()},[K]);return(0,c.useEffect)(()=>(C.current=!1,F().then(()=>K()),B.current=setInterval(()=>{C.current||F()},j),()=>{C.current=!0,B.current&&clearInterval(B.current),y.current?.close()}),[b,d,g,h,i]),{requests:m,live:s,loading:o,error:q,refresh:L,upsertById:G,forceReconnect:M,recentlyChangedIds:u}}({token:e.authService.getAccessToken(),pageSize:50,activeOnly:!1,resyncIntervalMs:3e5});(0,c.useEffect)(()=>{z&&i(z)},[z]);let[D,E]=(0,c.useState)([]),F=async(a,b)=>{E(b=>b.includes(a)?b:[...b,a]);try{await f.requestsService.changeRequestStatus(a,b)}catch(a){i(a instanceof Error?a.message:"Failed to change status")}finally{E(b=>b.filter(b=>b!==a))}},G=(0,c.useMemo)(()=>{let a=w.filter(a=>(!o||a.category===o)&&(!q||a.status===q)&&(!s||a.fabrication?.fab_type===s)&&(!u||!!((a.notes||"")+" "+a.bom_items.map(a=>a.item_name).join(" ")+" "+a.additional_items.map(a=>a.item_name).join(" ")).toLowerCase().includes(u.toLowerCase()))&&!0);return q?a:a.filter(a=>"Issued"!==a.status&&"Cannot be Processed"!==a.status)},[w,o,q,s,u]),H=(0,c.useMemo)(()=>({total:G.length,submitted:G.filter(a=>"Submitted"===a.status).length,processing:G.filter(a=>"Processing"===a.status).length,issued:G.filter(a=>"Issued"===a.status).length,rejected:G.filter(a=>"Cannot be Processed"===a.status).length}),[G]);return(0,b.jsx)(h.DashboardShell,{children:(0,b.jsxs)("div",{className:"space-y-8",children:[(0,b.jsx)("div",{className:"w-full bg-white border border-gray-200 rounded-lg overflow-hidden",children:(0,b.jsxs)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5",children:[(0,b.jsx)(l,{label:"Total",value:H.total,color:"#002449"}),(0,b.jsx)(l,{label:"Submitted",value:H.submitted,color:"#f75700"}),(0,b.jsx)(l,{label:"Processing",value:H.processing,color:"#007367"}),(0,b.jsx)(l,{label:"Issued",value:H.issued,color:"#078e31"}),(0,b.jsx)(l,{label:"Rejected",value:H.rejected,color:"#6b7280"})]})}),(0,b.jsx)(n,{live:x,onRefresh:A,onReconnect:B,ordering:"FCFS"}),(0,b.jsx)("div",{className:"bg-white border border-gray-200 rounded-lg p-3 flex flex-col gap-3",children:(0,b.jsxs)("div",{className:"flex flex-wrap gap-3 items-center",children:[(0,b.jsx)(m,{label:"Category",value:o,onChange:p,options:["","BOM","ADDITIONAL","FABRICATION"]}),(0,b.jsx)(m,{label:"Status",value:q,onChange:r,options:["","Submitted","Processing","Issued","Cannot be Processed"]}),(0,b.jsx)(m,{label:"Fab",value:s,onChange:t,options:["","3D","LASER","OTHER"]}),(0,b.jsxs)("div",{className:"flex items-center gap-2 ml-auto w-full sm:w-auto",children:[(0,b.jsx)("input",{type:"text",placeholder:"Search",value:u,onChange:a=>v(a.target.value),className:"px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-accent w-full sm:w-56"}),(0,b.jsx)("button",{onClick:()=>{p(""),r(""),t(""),v("")},className:"px-3 py-2 text-sm rounded-md border border-gray-300 hover:bg-gray-50",children:"Clear"})]})]})}),g&&(0,b.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-6",children:(0,b.jsx)("p",{className:"text-red-800",children:g})}),(0,b.jsx)("div",{className:"space-y-3",children:y?(0,b.jsx)("div",{className:"py-12 text-center text-sm text-gray-600 bg-white border border-gray-200 rounded-lg",children:"Loading queue..."}):0===G.length?(0,b.jsx)("div",{className:"py-12 text-center text-sm text-gray-600 bg-white border border-gray-200 rounded-lg",children:"No requests match filters."}):(0,b.jsx)("ul",{className:"space-y-3",children:G.map((a,c)=>(0,b.jsx)("li",{children:(0,b.jsx)(k,{request:a,position:c+1,onAdvance:F,canAdvance:!!j&&(j.is_poc||j.is_admin),highlight:C.includes(a.id),loading:D.includes(a.id)})},a.id))})})]})})}function k({request:a,position:c,onAdvance:d,canAdvance:e,highlight:f=!1,loading:h=!1}){var j,k;let l="Submitted"===a.status?"Processing":"Processing"===a.status?"Issued":"";return(0,b.jsxs)("div",{className:`relative bg-white border border-gray-200 rounded-lg p-4 flex flex-col gap-3 shadow-sm hover:shadow-md transition ${f?"flash-update":""} ${h?"opacity-60 pointer-events-none":""}`,children:[(0,b.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,b.jsx)("span",{className:"inline-flex items-center justify-center w-6 h-6 text-[11px] font-semibold rounded-full bg-gray-100 border border-gray-200 text-gray-600",children:c}),(0,b.jsx)("span",{className:"px-2 py-1 text-[11px] font-semibold text-white rounded-md",style:{backgroundColor:"BOM"===(j=a.category)?"#002449":"ADDITIONAL"===j?"#007367":"FABRICATION"===j?"#f75700":"#6b7280"},children:a.category}),(0,b.jsx)(i.RequestProgress,{status:a.status}),(0,b.jsx)("span",{className:"px-2 py-1 text-[11px] font-semibold rounded-md",style:{backgroundColor:"Submitted"===(k=a.status)?"#f75700":"Processing"===k?"#007367":"Issued"===k?"#078e31":"Cannot be Processed"===k?"#6b7280":"#002449",color:"#fff"},children:a.status}),a.team_name&&(0,b.jsx)("span",{className:"ml-auto inline-flex items-center gap-1 px-3 py-1 text-[11px] font-semibold rounded-full bg-[#002449] text-white",children:a.team_name})]}),(0,b.jsx)("h3",{className:"text-sm font-semibold text-gray-900 line-clamp-2",children:(0,g.formatRequestTitle)(a)}),(0,b.jsxs)("div",{className:"flex flex-wrap gap-4 text-[11px] text-gray-600",children:[(a.bom_items?.length||0)>0&&(0,b.jsxs)("span",{children:["BOM: ",a.bom_items.length]}),(a.additional_items?.length||0)>0&&(0,b.jsxs)("span",{children:["Additional: ",a.additional_items.length]}),a.fabrication&&(0,b.jsxs)("span",{children:["Fab: ",a.fabrication.fab_type," â€¢ ",a.fabrication.name]}),(0,b.jsxs)("span",{children:["Created: ",new Date(a.created_at).toLocaleTimeString()]}),(0,b.jsxs)("span",{children:["Updated: ",new Date(a.updated_at).toLocaleTimeString()]})]}),(0,b.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,b.jsx)("a",{href:`/requests/${a.id}`,className:"px-3 py-1.5 text-[11px] font-medium rounded-md border border-gray-300 hover:bg-gray-50",children:"View"}),e&&l&&(0,b.jsx)("button",{onClick:()=>d(a.id,l),className:"px-3 py-1.5 text-[11px] font-medium rounded-md text-white",style:{backgroundColor:"Processing"===l?"#007367":"#078e31"},children:"Processing"===l?"Accept":"Issue"}),e&&"Issued"!==a.status&&"Cannot be Processed"!==a.status&&(0,b.jsx)("button",{onClick:()=>d(a.id,"Cannot be Processed"),className:"px-3 py-1.5 text-[11px] font-medium rounded-md text-white bg-[#f75700]",children:"Reject"}),h&&(0,b.jsx)("span",{className:"inline-flex items-center gap-1 px-2 py-1 text-[10px] font-medium rounded bg-gray-800 text-white",children:"Updating..."})]})]})}function l({label:a,value:c,color:d}){return(0,b.jsxs)("div",{className:"flex items-center justify-between gap-2 px-4 py-2 text-sm border-r last:border-r-0 border-gray-200",children:[(0,b.jsx)("span",{className:"text-[11px] font-medium text-gray-500 uppercase tracking-wide",children:a}),(0,b.jsx)("span",{className:"text-base font-semibold",style:{color:d},children:c})]})}function m({label:a,options:c,value:d,onChange:e}){return(0,b.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,b.jsx)("span",{className:"text-[10px] uppercase tracking-wide font-semibold text-gray-500",children:a}),(0,b.jsx)("div",{className:"flex flex-wrap gap-1",children:c.map(a=>(0,b.jsx)("button",{onClick:()=>e(a),className:(0,g.cn)("px-2 py-1 text-[11px] rounded-md border transition-colors",d===a?"bg-accent text-white border-accent":"bg-white hover:bg-gray-50 text-gray-600 border-gray-300"),type:"button",children:""===a?"All":a},a||"all"))})]})}function n({live:a,ordering:c,onRefresh:d,onReconnect:e}){return(0,b.jsxs)("div",{className:"flex flex-wrap gap-3 items-center bg-white border border-gray-200 rounded-lg p-3",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsxs)("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-md text-[11px] font-medium ${a?"bg-green-50 text-green-700 border border-green-200":"bg-red-50 text-red-700 border border-red-200"}`,children:[(0,b.jsx)("span",{className:`inline-block w-2 h-2 rounded-full ${a?"bg-green-500 animate-pulse":"bg-red-500"}`}),a?"Live":"Disconnected"]}),(0,b.jsxs)("span",{className:"inline-flex items-center gap-1 px-2 py-1 rounded-md text-[11px] font-medium bg-gray-50 border border-gray-200",children:["Ordering: ",c]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2 ml-auto",children:[(0,b.jsx)("button",{onClick:d,className:"px-3 py-1.5 text-[11px] font-medium rounded-md border border-gray-300 hover:bg-gray-50",children:"Refresh"}),(0,b.jsx)("button",{onClick:e,className:"px-3 py-1.5 text-[11px] font-medium rounded-md border border-gray-300 hover:bg-gray-50",children:"Reconnect"})]})]})}a.s(["default",()=>j],91248)}];

//# sourceMappingURL=app_queue_page_tsx_8c540344._.js.map